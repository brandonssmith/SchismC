# PE Format and Windows Executable Generation

## Overview

SchismC generates native Windows PE (Portable Executable) executables directly from HolyC source code. This document explains our approach and the tools we use.

## PE Format Structure

The PE format consists of several key sections:

### 1. DOS Header
- Legacy compatibility header
- Points to PE signature

### 2. PE Signature
- 4-byte signature: "PE\0\0"

### 3. COFF Header
- Machine type (x64)
- Number of sections
- Timestamp and symbols

### 4. Optional Header
- Entry point address
- Image base address
- Section alignment
- Subsystem type (Console/GUI)

### 5. Section Headers
- `.text` - Code section
- `.data` - Initialized data
- `.rdata` - Read-only data
- `.idata` - Import table
- `.edata` - Export table

## Our Approach

### Phase 1: Assembly Generation
SchismC generates x86-64 assembly code from HolyC source:

```assembly
; Generated by SchismC
.model flat, c
.code

main PROC
    ; HolyC code translated to assembly
    mov rax, 0
    ret
main ENDP

END
```

### Phase 2: Assembly with MASM
We use Microsoft's MASM (ml64.exe) to assemble:

```cmd
ml64.exe /c /Cp /Cx /W3 /nologo input.asm /Fo output.obj
```

### Phase 3: Linking with link.exe
We use Microsoft's linker to create the final PE:

```cmd
link.exe /SUBSYSTEM:CONSOLE /ENTRY:main output.obj /OUT:program.exe
```

## Tools Required

### 1. MASM (Microsoft Macro Assembler)
- **What**: Microsoft's x86-64 assembler
- **Where**: Visual Studio or Windows SDK
- **Command**: `ml64.exe`
- **Purpose**: Convert assembly to object files

### 2. Link.exe (Microsoft Linker)
- **What**: Microsoft's linker
- **Where**: Visual Studio or Windows SDK
- **Command**: `link.exe`
- **Purpose**: Create PE executables from object files

### 3. Windows SDK
- **What**: Development tools for Windows
- **Where**: Microsoft Developer Tools
- **Includes**: MASM, Linker, PE utilities
- **Purpose**: Complete Windows development environment

## Alternative Approaches

### Option 1: Direct PE Generation
- Write our own PE generator
- More control but complex
- Requires deep PE format knowledge

### Option 2: Use NASM + MinGW
- NASM for assembly
- GCC for linking
- Cross-platform but less Windows-specific

### Option 3: Use Windows API
- `ImageHlp.lib` for PE manipulation
- `DbgHelp.lib` for debugging
- More Windows integration

## Our Choice: MASM + Link.exe

We chose MASM + Link.exe because:

1. **Native Windows**: Best Windows integration
2. **Industry Standard**: Used by Microsoft tools
3. **PE Compatibility**: Generates standard PE format
4. **Debugging Support**: Full debugging capabilities
5. **Performance**: Optimized for Windows

## Implementation Details

### Assembly Generation
```c
// Generate x86-64 assembly from intermediate code
void generate_assembly(CodeGenState* cg, ICGenerator* ic) {
    // Convert intermediate code to x86-64 assembly
    for (int i = 0; i < ic->instruction_count; i++) {
        switch (ic->instructions[i].opcode) {
            case IC_LOAD_IMMEDIATE:
                emit_mov_rax_imm(cg, ic->instructions[i].operand1);
                break;
            case IC_ADD:
                emit_add_rax_rbx(cg);
                break;
            // ... more instructions
        }
    }
}
```

### PE Creation
```c
// Create PE executable from assembly
bool create_pe_executable(const char* asm_file, const char* exe_file) {
    // 1. Assemble with MASM
    if (!assemble_with_masm(asm_file, "temp.obj")) {
        return false;
    }
    
    // 2. Link with link.exe
    if (!link_with_linker("temp.obj", exe_file, "main", true)) {
        return false;
    }
    
    // 3. Clean up
    remove("temp.obj");
    return true;
}
```

## Testing

Use our test script to verify the toolchain:

```cmd
tools\test_toolchain.bat
```

This will check for:
- GCC availability
- MASM availability  
- Linker availability
- Make utility

## Future Enhancements

1. **Custom PE Generator**: Write our own PE generator for more control
2. **Debug Information**: Add PDB file generation
3. **Import/Export Tables**: Handle DLL imports/exports
4. **Resource Sections**: Support Windows resources
5. **Code Signing**: Add digital signatures

## References

- [PE Format Specification](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format)
- [MASM Reference](https://docs.microsoft.com/en-us/cpp/assembler/masm/)
- [Linker Reference](https://docs.microsoft.com/en-us/cpp/build/reference/linking)
- [Windows SDK](https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/)
